{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify OTP - ChatBot</title>
    <link rel="stylesheet" href="{% static 'chat/auth.css' %}">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="bot-avatar large">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM8 17C7.45 17 7 16.55 7 16C7 15.45 7.45 15 8 15C8.55 15 9 15.45 9 16C9 16.55 8.55 17 8 17ZM9 13C9 13.55 8.55 14 8 14C7.45 14 7 13.55 7 13V9C7 8.45 7.45 8 8 8C8.55 8 9 8.45 9 9V13ZM12 18C10.9 18 10 17.1 10 16H14C14 17.1 13.1 18 12 18ZM16 14C15.45 14 15 13.55 15 13V9C15 8.45 15.45 8 16 8C16.55 8 17 8.45 17 9V13C17 13.55 16.55 14 16 14Z" fill="currentColor"/>
                    </svg>
                </div>
                <h2>Verify OTP</h2>
                <p>Enter the OTP sent to your email</p>
            </div>

            {% if error %}
            <div class="notification error">{{ error }}</div>
            {% endif %}

            <form method="post" class="auth-form">
                {% csrf_token %}
                <input type="hidden" name="email" value="{{ email }}">
                
                <div class="form-group">
                    <input
                        type="text"
                        name="otp_code"
                        placeholder="Enter OTP"
                        required
                        maxlength="6"
                        pattern="[0-9]{6}"
                    />
                </div>

                <button type="submit" class="auth-btn">
                    <span class="btn-text">Verify OTP</span>
                </button>
            </form>

            <div class="auth-footer">
                <p>Didn't receive the code? <a href="#" id="resend-otp">Resend OTP</a></p>
                <p><a href="/forgot-password/">Back to Forgot Password</a></p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("resend-otp").addEventListener("click", function(e) {
            e.preventDefault();
            resendOtp();
        });

        function resendOtp() {
            const email = "{{ email }}";
            const resendLink = document.getElementById("resend-otp");

            resendLink.textContent = "Sending...";
            resendLink.style.pointerEvents = "none";

            fetch("/resend-otp-password/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ email: email, purpose: "password_reset" }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("OTP sent successfully!");
                } else {
                    alert(data.error || "Failed to resend OTP");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("An error occurred. Please try again.");
            })
            .finally(() => {
                resendLink.textContent = "Resend OTP";
                resendLink.style.pointerEvents = "auto";
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
