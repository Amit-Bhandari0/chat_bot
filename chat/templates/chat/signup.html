{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up - ChatBot</title>
    <link rel="stylesheet" href="{% static 'chat/auth.css' %}" />
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <div class="bot-avatar large">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM8 17C7.45 17 7 16.55 7 16C7 15.45 7.45 15 8 15C8.55 15 9 15.45 9 16C9 16.55 8.55 17 8 17ZM9 13C9 13.55 8.55 14 8 14C7.45 14 7 13.55 7 13V9C7 8.45 7.45 8 8 8C8.55 8 9 8.45 9 9V13ZM12 18C10.9 18 10 17.1 10 16H14C14 17.1 13.1 18 12 18ZM16 14C15.45 14 15 13.55 15 13V9C15 8.45 15.45 8 16 8C16.55 8 17 8.45 17 9V13C17 13.55 16.55 14 16 14Z"
                fill="currentColor"
              />
            </svg>
          </div>
          <h2>Create Account</h2>
          <p>Sign up to get started with ChatBot</p>
        </div>

        <div id="notification" class="notification hidden"></div>

        <form method="post" class="auth-form" id="signup-form">
          {% csrf_token %}
          <div class="form-group">
            <input
              type="text"
              name="username"
              id="username"
              placeholder="Username"
              required
              minlength="3"
              maxlength="150"
              pattern="[a-zA-Z0-9_]+"
              title="Username can only contain letters, numbers, and underscores."
              autocomplete="username"
            />
            <div class="error-message" id="username-error"></div>
          </div>
          <div class="form-group">
            <input
              type="email"
              name="email"
              id="email"
              placeholder="Email"
              required
              autocomplete="email"
            />
            <div class="error-message" id="email-error"></div>
          </div>
          <div class="form-group password-field">
            <input
              type="password"
              name="password1"
              id="password1"
              placeholder="Password"
              required
              minlength="8"
              autocomplete="new-password"
              pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
              title="Must contain at least one number, one uppercase and lowercase letter, and at least 8 or more characters"
            />
            <button
              type="button"
              class="toggle-password"
              aria-label="Toggle password visibility"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 9C11.2044 9 10.4413 9.31607 9.87868 9.87868C9.31607 10.4413 9 11.2044 9 12C9 12.7956 9.31607 13.5587 9.87868 14.1213C10.4413 14.6839 11.2044 15 12 15C12.7956 15 13.5587 14.6839 14.1213 14.1213C14.6839 13.5587 15 12.7956 15 12C15 11.2044 14.6839 10.4413 14.1213 9.87868C13.5587 9.31607 12.7956 9 12 9Z"
                  fill="currentColor"
                />
                <path
                  d="M21.87 11.5C21.23 10.39 17.71 4.82 12 4.82C6.29 4.82 2.77 10.39 2.13 11.5C1.95 11.81 1.95 12.19 2.13 12.5C2.77 13.61 6.29 19.18 12 19.18C17.71 19.18 21.23 13.61 21.87 12.5C22.05 12.19 22.05 11.81 21.87 11.5ZM12 16.5C9.51472 16.5 7.5 14.4853 7.5 12C7.5 9.51472 9.51472 7.5 12 7.5C14.4853 7.5 16.5 9.51472 16.5 12C16.5 14.4853 14.4853 16.5 12 16.5Z"
                  fill="currentColor"
                />
              </svg>
            </button>
            <div class="error-message" id="password1-error"></div>
          </div>
          <div class="password-requirements">
            Use a strong password including uppercase, lowercase, numbers, and
            special characters
          </div>
          <div class="form-group password-field">
            <input
              type="password"
              name="password2"
              id="password2"
              placeholder="Confirm Password"
              required
              autocomplete="new-password"
            />
            <button
              type="button"
              class="toggle-password"
              aria-label="Toggle password visibility"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 9C11.2044 9 10.4413 9.31607 9.87868 9.87868C9.31607 10.4413 9 11.2044 9 12C9 12.7956 9.31607 13.5587 9.87868 14.1213C10.4413 14.6839 11.2044 15 12 15C12.7956 15 13.5587 14.6839 14.1213 14.1213C14.6839 13.5587 15 12.7956 15 12C15 11.2044 14.6839 10.4413 14.1213 9.87868C13.5587 9.31607 12.7956 9 12 9Z"
                  fill="currentColor"
                />
                <path
                  d="M21.87 11.5C21.23 10.39 17.71 4.82 12 4.82C6.29 4.82 2.77 10.39 2.13 11.5C1.95 11.81 1.95 12.19 2.13 12.5C2.77 13.61 6.29 19.18 12 19.18C17.71 19.18 21.23 13.61 21.87 12.5C22.05 12.19 22.05 11.81 21.87 11.5ZM12 16.5C9.51472 16.5 7.5 14.4853 7.5 12C7.5 9.51472 9.51472 7.5 12 7.5C14.4853 7.5 16.5 9.51472 16.5 12C16.5 14.4853 14.4853 16.5 12 16.5Z"
                  fill="currentColor"
                />
              </svg>
            </button>
            <div class="error-message" id="password2-error"></div>
          </div>
          <button type="submit" class="auth-btn" id="signup-btn">
            <span class="btn-text">Sign Up</span>
            <div class="btn-loader hidden"></div>
          </button>
        </form>

        <div class="auth-footer">
          <p>Already have an account? <a href="/login/">Sign In</a></p>
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("signup-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          submitSignupForm();
        });

      document.querySelectorAll(".toggle-password").forEach((button) => {
        button.addEventListener("click", function () {
          const input = this.previousElementSibling;
          if (input.type === "password") {
            input.type = "text";
          } else {
            input.type = "password";
          }
        });
      });

      function showNotification(message, type = "error") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.classList.remove("hidden");

        setTimeout(() => {
          notification.classList.add("hidden");
        }, 5000);
      }

      function submitSignupForm() {
        const form = document.getElementById("signup-form");
        const formData = new FormData(form);
        const signupBtn = document.getElementById("signup-btn");
        const btnText = signupBtn.querySelector(".btn-text");
        const btnLoader = signupBtn.querySelector(".btn-loader");

        document.querySelectorAll(".error-message").forEach((el) => {
          el.textContent = "";
        });

        btnText.classList.add("hidden");
        btnLoader.classList.remove("hidden");
        signupBtn.disabled = true;

        fetch("/signup/", {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              if (data.redirect) {
                window.location.href = data.redirect;
              }
            } else {
              if (data.errors) {
                for (const [field, error] of Object.entries(data.errors)) {
                  const errorElement = document.getElementById(
                    `${field}-error`
                  );
                  if (errorElement) {
                    errorElement.textContent = error;
                  } else {
                    showNotification(error);
                  }
                }
              }
            }
          })
          .catch(() => {
            showNotification("An error occurred. Please try again.");
          })
          .finally(() => {
            btnText.classList.remove("hidden");
            btnLoader.classList.add("hidden");
            signupBtn.disabled = false;
          });
      }
    </script>
  </body>
</html>
